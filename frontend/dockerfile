
FROM node:24-bullseye

ARG APP_ENV
ARG NEXT_PUBLIC_EXPLORER_URL
ARG NEXT_PUBLIC_DAPP_URL
ARG NEXT_PUBLIC_NETWORK_URL
ARG NEXT_PUBLIC_AUDIT_TRAIL_PKG
ARG NEXT_PUBLIC_REWARD_WHITELIST_ID
ARG NEXT_PUBLIC_REWARD_VAULT_ID
ARG NEXT_PUBLIC_REWARD_VAULT_TREASURE_CAP_ID
ARG NEXT_PUBLIC_ADMIN_CAP_ID
ARG NEXT_PUBLIC_REFRESH_INTERVAL_MS
ARG NEXT_PUBLIC_HAS_NFT_REWARD
ARG NEXT_PUBLIC_NETWORK
ARG NEXT_PUBLIC_PRODUCT_ID
ARG NEXT_PUBLIC_FEDERATION_ID
ARG NEXT_PUBLIC_IOTA_IDENTITY_PKG_ID
ARG IOTA_IDENTITY_PKG_ID
ARG BACKEND_ENDPOINT
ARG BACKEND_API_KEY
ARG GAS_STATION_URL
ARG GAS_STATION_AUTH
ARG NEXT_PUBLIC_MANUFACTURER_DID

ENV APP_ENV=${APP_ENV}
ENV NEXT_PUBLIC_MANUFACTURER_DID=${NEXT_PUBLIC_MANUFACTURER_DID}
ENV NEXT_PUBLIC_EXPLORER_URL=$NEXT_PUBLIC_EXPLORER_URL
ENV NEXT_PUBLIC_DAPP_URL=$NEXT_PUBLIC_DAPP_URL
ENV NEXT_PUBLIC_NETWORK_URL=$NEXT_PUBLIC_NETWORK_URL
ENV NEXT_PUBLIC_AUDIT_TRAIL_PKG=$NEXT_PUBLIC_AUDIT_TRAIL_PKG
ENV NEXT_PUBLIC_REWARD_WHITELIST_ID=$NEXT_PUBLIC_REWARD_WHITELIST_ID
ENV NEXT_PUBLIC_REWARD_VAULT_ID=${NEXT_PUBLIC_REWARD_VAULT_ID}
ENV NEXT_PUBLIC_REWARD_VAULT_TREASURE_CAP_ID=${NEXT_PUBLIC_REWARD_VAULT_TREASURE_CAP_ID}
ENV NEXT_PUBLIC_ADMIN_CAP_ID=$NEXT_PUBLIC_ADMIN_CAP_ID
ENV NEXT_PUBLIC_REFRESH_INTERVAL_MS=$NEXT_PUBLIC_REFRESH_INTERVAL_MS
ENV NEXT_PUBLIC_HAS_NFT_REWARD=$NEXT_PUBLIC_HAS_NFT_REWARD
ENV NEXT_PUBLIC_NETWORK=$NEXT_PUBLIC_NETWORK
ENV NEXT_PUBLIC_PRODUCT_ID=$NEXT_PUBLIC_PRODUCT_ID
ENV NEXT_PUBLIC_FEDERATION_ID=${NEXT_PUBLIC_FEDERATION_ID}
ENV NEXT_PUBLIC_IOTA_IDENTITY_PKG_ID=${NEXT_PUBLIC_IOTA_IDENTITY_PKG_ID}
ENV IOTA_IDENTITY_PKG_ID=$IOTA_IDENTITY_PKG_ID
ENV BACKEND_ENDPOINT=$BACKEND_ENDPOINT
ENV BACKEND_API_KEY=$BACKEND_API_KEY
ENV GAS_STATION_URL=$GAS_STATION_URL
ENV GAS_STATION_AUTH=$GAS_STATION_AUTH

WORKDIR /usr/src/app

COPY package*.json ./
RUN npm install

COPY . .

# Setup Domain Linkage per environment
RUN if [ "$APP_ENV" = "prod" ]; then \
      mv -f public/.well-known/did-configuration.prod.json public/.well-known/did-configuration.json; \
      rm ./public/.well-known/did-configuration.dev.json; \
    else \
      mv -f public/.well-known/did-configuration.dev.json public/.well-known/did-configuration.json; \
      rm ./public/.well-known/did-configuration.prod.json; \
    fi

RUN npm run build

EXPOSE 3000

CMD ["npm", "start"]
